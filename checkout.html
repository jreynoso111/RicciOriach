<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | Riccie Oriach</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #300505;
            --color-text: #F4F4F4;
            --color-accent: #FF5E6C;
            --color-secondary: #FFD700;
            --color-outline: rgba(255, 94, 108, 0.7);
            --card: rgba(255, 255, 255, 0.06);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Outfit', sans-serif;
            background: radial-gradient(circle at 50% 50%, #3a0a0a 0%, #180303 100%);
            color: var(--color-text);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background-image: url('assets/texture.png');
            background-size: cover;
            opacity: 0.22;
            z-index: -2;
            pointer-events: none;
        }
        body::after {
            content: "";
            position: fixed;
            inset: 0;
            background: linear-gradient(45deg, rgba(255,94,108,0.12), transparent);
            z-index: -1;
            pointer-events: none;
        }
        #canvas-bg {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
        .navbar {
            display: flex;
            align-items: center;
            padding: 1.25rem 2rem;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 10;
        }
        .logo a {
            font-family: 'Abril Fatface', cursive;
            font-size: 1.4rem;
            color: var(--color-secondary);
            text-decoration: none;
            letter-spacing: 1px;
        }
        .nav-links {
            list-style: none;
            display: flex;
            gap: 1.75rem;
            margin-left: auto;
        }
        .nav-links a {
            color: var(--color-text);
            text-decoration: none;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .nav-links a.active { color: var(--color-accent); }
        .page-hero {
            padding: 8rem 2rem 3rem;
            max-width: 1100px;
            margin: 0 auto;
        }
        .page-hero h1 { font-size: 2.6rem; margin-bottom: 0.5rem; letter-spacing: 1px; }
        .page-hero p { color: rgba(244,244,244,0.8); }
        .steps { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-top: 1.5rem; }
        .step {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 1rem;
            border-radius: 12px;
        }
        .step h4 { margin-bottom: 0.35rem; }
        .main-grid {
            display: grid;
            grid-template-columns: 1.1fr 0.9fr;
            gap: 1.5rem;
            max-width: 1100px;
            margin: 1rem auto 3rem;
            padding: 0 2rem 2rem;
        }
        .session-banner {margin-top:0.75rem;padding:0.75rem 1rem;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.06);color:rgba(244,244,244,0.9);}        
        .session-banner a{color:var(--color-secondary);font-weight:700;text-decoration:none;}
        .card {
            background: var(--card);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 14px;
            padding: 1.25rem;
            box-shadow: 0 12px 30px rgba(0,0,0,0.28);
        }
        .card h3 { margin-bottom: 0.65rem; letter-spacing: 0.5px; }
        .cart-list { display: flex; flex-direction: column; gap: 0.9rem; }
        .cart-row {
            display: grid;
            grid-template-columns: 60px 1fr auto;
            gap: 0.75rem;
            align-items: center;
            padding: 0.75rem;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .cart-row img { width: 60px; height: 60px; object-fit: cover; border-radius: 10px; }
        .cart-row .title { font-weight: 700; }
        .cart-row .meta { color: rgba(244,244,244,0.7); font-size: 0.9rem; }
        .qty { display: inline-flex; align-items: center; gap: 0.35rem; background: rgba(255,255,255,0.05); padding: 0.35rem 0.6rem; border-radius: 999px; }
        .qty button { background: none; border: 1px solid rgba(255,255,255,0.3); color: var(--color-text); border-radius: 50%; width: 28px; height: 28px; cursor: pointer; }
        .tag { display: inline-flex; align-items: center; gap: 0.3rem; padding: 0.35rem 0.6rem; border-radius: 8px; background: rgba(255,94,108,0.15); color: var(--color-accent); font-weight: 700; }
        .totals { margin-top: 1rem; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 1rem; display: grid; gap: 0.35rem; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        form { display: grid; gap: 0.65rem; }
        label { font-weight: 600; font-size: 0.95rem; }
        input, textarea, select {
            width: 100%;
            background: rgba(0,0,0,0.25);
            border: 1px solid rgba(255,255,255,0.12);
            color: var(--color-text);
            padding: 0.65rem 0.75rem;
            border-radius: 10px;
            font-size: 1rem;
        }
        textarea { min-height: 90px; resize: vertical; }
        .actions { display: flex; gap: 0.8rem; margin-top: 0.5rem; }
        .btn {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 0.35rem;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            border: 1px solid var(--color-outline);
            background: linear-gradient(120deg, rgba(255,94,108,0.18), rgba(255,94,108,0.08));
            color: var(--color-text);
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
        }
        .btn.secondary { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.2); }
        .empty { text-align: center; color: rgba(244,244,244,0.7); padding: 1rem 0; }
        .confirmation {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 12px;
            background: rgba(0, 128, 85, 0.2);
            border: 1px solid rgba(0, 255, 170, 0.25);
            display: none;
        }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <canvas id="canvas-bg"></canvas>
    <nav class="navbar">
        <div class="logo"><a href="index.html">RICCIE ORIACH</a></div>
        <ul class="nav-links">
            <li><a href="index.html">INICIO</a></li>
            <li><a href="music.html">M√öSICA</a></li>
            <li><a href="merch.html">MERCH</a></li>
            <li><a href="events.html">TICKETS</a></li>
            <li><a href="blog.html">BLOG</a></li>
            <li><a href="contact.html">CONTACTO</a></li>
            <li><a href="perfil.html">PERFIL</a></li>
            <li><a class="active" href="checkout.html">CHECKOUT</a></li>
            <li><a href="auth/login.html">ACCESO</a></li>
        </ul>
    </nav>

    <header class="page-hero">
        <p>PASO 2 ¬∑ CHECKOUT</p>
        <h1>Confirma tus datos y env√≠o</h1>
        <p>Revisa el carrito, rellena tu direcci√≥n y deja listo el flujo para procesar pagos m√°s adelante.</p>
        <div class="session-banner" id="session-banner">Accede con tu cuenta para precargar tus datos. <a href="auth/login.html">Iniciar sesi√≥n</a> ¬∑ <a href="auth/register.html">Registrarme</a></div>
        <div class="steps">
            <div class="step"><h4>üõí Carrito</h4><p>Los productos se cargan desde tu carrito guardado.</p></div>
            <div class="step"><h4>ü™™ Perfil</h4><p>Usamos tus datos guardados para prellenar el formulario.</p></div>
            <div class="step"><h4>üì¶ Env√≠o</h4><p>Selecciona m√©todo de entrega y agrega notas.</p></div>
            <div class="step"><h4>üí≥ Pago</h4><p>Estructura preparada para conectar pasarela.</p></div>
        </div>
    </header>

    <section class="main-grid">
        <div class="card" id="cart-summary">
            <div class="flex-between"><h3>Resumen de carrito</h3><a class="btn secondary" href="merch.html">Volver a la tienda</a></div>
            <div class="cart-list" id="cart-list"></div>
            <div class="totals">
                <div class="flex-between"><span>Subtotal</span><strong id="subtotal">$0.00</strong></div>
                <div class="flex-between"><span>Env√≠o estimado</span><span id="shipping">$0.00</span></div>
                <div class="flex-between"><span>Impuestos estimados</span><span id="taxes">$0.00</span></div>
                <div class="flex-between"><span>Total</span><strong id="grand-total">$0.00</strong></div>
            </div>
        </div>
        <div class="card">
            <h3>Datos de contacto y env√≠o</h3>
            <form id="checkout-form">
                <div class="grid">
                    <label>Nombre completo
                        <input type="text" id="fullName" required>
                    </label>
                </div>
                <label>Correo electr√≥nico
                    <input type="email" id="email" required>
                </label>
                <label>Tel√©fono
                    <input type="tel" id="phone" placeholder="WhatsApp para actualizaciones" required>
                </label>
                <label>Direcci√≥n
                    <input type="text" id="address" placeholder="Calle, n√∫mero y sector" required>
                </label>
                <label>Ciudad
                    <input type="text" id="city" required>
                </label>
                <label>Pa√≠s
                    <input type="text" id="country" value="Rep√∫blica Dominicana" required>
                </label>
                <label>M√©todo de env√≠o
                    <select id="shipping-method">
                        <option value="pickup">Recogida en evento / pickup</option>
                        <option value="domicilio">Entrega a domicilio</option>
                    </select>
                </label>
                <label>Notas adicionales
                    <textarea id="notes" placeholder="Indicaciones para entrega o talla"></textarea>
                </label>
                <label>M√©todo de pago (demo)
                    <select id="payment-method">
                        <option value="card">Tarjeta (activar gateway luego)</option>
                        <option value="transfer">Transferencia / Zelle</option>
                        <option value="cash">Pago contra entrega</option>
                    </select>
                </label>
                <div class="actions">
                    <button type="button" class="btn secondary" id="save-profile">Guardar perfil</button>
                    <button type="submit" class="btn">Crear orden y preparar pago</button>
                </div>
                <div class="confirmation" id="confirmation"></div>
            </form>
        </div>
    </section>

    <section class="main-grid" style="grid-template-columns: 1fr;">
        <div class="card">
            <h3>Integraci√≥n de pagos lista para conectar</h3>
            <p style="color: rgba(244,244,244,0.75);">Conservamos los items, el total y los datos de contacto en localStorage (orden en estado "Pendiente de pago"). Solo falta conectar la pasarela (Stripe, CardNet, Azul, PayPal) en el bot√≥n de confirmar.</p>
            <div class="actions" style="margin-top: 1rem;">
                <a class="btn" href="ordenes.html">Ver √≥rdenes guardadas</a>
                <a class="btn secondary" href="perfil.html">Ajustar datos del perfil</a>
            </div>
        </div>
    </section>
    <script src="auth/auth.js"></script>
    <script>
        const catalogKey = 'merchCatalog';
        const cartKey = 'ricciCart';
        const ordersKey = 'ricciOrders';
        const defaultCatalog = [
            { id: 201, name: 'Sudadera "Ritmo Solar"', price: 55, stock: 8, status: 'Visible', description: 'Sudadera bordada con gr√°ficos folclore futurista y capucha forrada.', link: 'https://example.com/ritmo-solar', image: 'merch_nuevo_drop.jpg' },
            { id: 202, name: 'Camiseta "Maquin√©"', price: 35, stock: 30, status: 'Visible', description: 'Camiseta suave de algod√≥n org√°nico con tipograf√≠a Maquin√©.', link: 'https://example.com/maquine', image: 'merch_camiseta_maquine.jpg' },
            { id: 203, name: 'Vinilo "Mi Derriengue"', price: 40, stock: 0, status: 'Agotado', description: 'Prensado en 180g con arte alternativo y letras impresas.', link: 'https://example.com/derriengue', image: 'merch_vinilo_la_guayaba.jpg' },
            { id: 204, name: 'Gorra Logo', price: 25, stock: 5, status: 'Visible', description: 'Gorra ajustable con logo psicod√©lico bordado.', link: 'https://example.com/gorra', image: 'merch_gorra_logo.jpg' }
        ];

        const sessionBanner = document.getElementById('session-banner');
        const cartList = document.getElementById('cart-list');
        const subtotalEl = document.getElementById('subtotal');
        const shippingEl = document.getElementById('shipping');
        const taxesEl = document.getElementById('taxes');
        const grandTotalEl = document.getElementById('grand-total');
        const checkoutForm = document.getElementById('checkout-form');
        const confirmation = document.getElementById('confirmation');
        const saveProfileBtn = document.getElementById('save-profile');

        const fields = ['fullName','email','phone','address','city','country','notes'];

        let cart = JSON.parse(localStorage.getItem(cartKey) || '[]');
        let activeSession = RicciAuth.getSession();

        function getCatalog() {
            const stored = localStorage.getItem(catalogKey);
            const parsed = stored ? JSON.parse(stored) : defaultCatalog;
            return parsed.filter(item => item.status !== 'Borrador');
        }

        function updateSessionBanner() {
            if (activeSession?.email) {
                sessionBanner.innerHTML = `Sesi√≥n activa: ${activeSession.email} (${activeSession.provider || 'correo'}). <a href="auth/login.html">Cambiar cuenta</a>`;
            } else {
                sessionBanner.innerHTML = 'Accede para precargar datos y asociar √≥rdenes. <a href="auth/login.html">Iniciar sesi√≥n</a> ¬∑ <a href="auth/register.html">Registrarme</a>';
            }
        }

        function loadProfile() {
            const profile = activeSession?.email ? RicciAuth.getProfileForUser(activeSession.email) : {};
            fields.forEach(id => {
                const input = document.getElementById(id);
                if (input && profile[id]) input.value = profile[id];
            });
            const shippingMethod = document.getElementById('shipping-method');
            if (shippingMethod && profile.shipping) shippingMethod.value = profile.shipping;
            const paymentMethod = document.getElementById('payment-method');
            if (paymentMethod && profile.payment) paymentMethod.value = profile.payment;
        }

        function saveProfile(showMessage = true) {
            if (!activeSession?.email) {
                confirmation.style.display = 'block';
                confirmation.textContent = 'Necesitas iniciar sesi√≥n o registrarte para guardar los datos de perfil.';
                return false;
            }
            const data = { shipping: document.getElementById('shipping-method').value, payment: document.getElementById('payment-method').value };
            fields.forEach(id => data[id] = document.getElementById(id).value.trim());
            RicciAuth.saveProfileForUser(activeSession.email, data);
            if (showMessage) {
                confirmation.style.display = 'block';
                confirmation.textContent = 'Perfil guardado. Tus datos quedar√°n listos para el pago cuando se active la pasarela.';
            }
            return true;
        }

        function refreshSession() {
            activeSession = RicciAuth.getSession();
            updateSessionBanner();
        }

        function renderCart() {
            const catalog = getCatalog();
            cartList.innerHTML = '';
            if (!cart.length) {
                cartList.innerHTML = '<p class="empty">Tu carrito est√° vac√≠o. Regresa a la tienda para a√±adir productos.</p>';
                subtotalEl.textContent = shippingEl.textContent = taxesEl.textContent = grandTotalEl.textContent = '$0.00';
                return;
            }
            let subtotal = 0;
            cart.forEach((item, index) => {
                const product = catalog.find(p => String(p.id) === String(item.id)) || defaultCatalog.find(p => String(p.id) === String(item.id));
                const price = Number(product?.price || 0);
                subtotal += price * item.qty;
                const row = document.createElement('div');
                row.className = 'cart-row';
                row.innerHTML = `
                    <img src="${product?.image || 'assets/hero.png'}" alt="${product?.name || 'Producto'}">
                    <div>
                        <div class="title">${product?.name || 'Producto'}</div>
                        <div class="meta">$${price.toFixed(2)} USD</div>
                        <div class="qty" data-index="${index}">
                            <button data-action="dec">-</button>
                            <span>${item.qty}</span>
                            <button data-action="inc">+</button>
                        </div>
                    </div>
                    <div class="tag">${product?.status === 'Agotado' ? 'Agotado' : 'En stock'}</div>
                `;
                cartList.appendChild(row);
            });
            const shipping = subtotal > 0 ? 6.5 : 0;
            const taxes = subtotal * 0.18;
            subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
            shippingEl.textContent = `$${shipping.toFixed(2)}`;
            taxesEl.textContent = `$${taxes.toFixed(2)}`;
            grandTotalEl.textContent = `$${(subtotal + shipping + taxes).toFixed(2)}`;
        }

        cartList.addEventListener('click', (event) => {
            const btn = event.target;
            if (!(btn instanceof HTMLElement) || !btn.dataset.action) return;
            const wrap = btn.closest('.qty');
            const idx = Number(wrap?.dataset.index);
            if (!Number.isInteger(idx)) return;
            if (btn.dataset.action === 'inc') cart[idx].qty += 1;
            if (btn.dataset.action === 'dec') cart[idx].qty = Math.max(1, cart[idx].qty - 1);
            localStorage.setItem(cartKey, JSON.stringify(cart));
            renderCart();
        });

        saveProfileBtn.addEventListener('click', (e) => {
            e.preventDefault();
            refreshSession();
            saveProfile();
        });

        checkoutForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!cart.length) {
                confirmation.style.display = 'block';
                confirmation.textContent = 'No hay productos en el carrito. A√±ade art√≠culos antes de confirmar la orden.';
                return;
            }
            refreshSession();
            if (!saveProfile(false)) return;
            const catalog = getCatalog();
            const subtotal = cart.reduce((sum, item) => {
                const p = catalog.find(prod => String(prod.id) === String(item.id)) || defaultCatalog.find(prod => String(prod.id) === String(item.id));
                return sum + Number(p?.price || 0) * item.qty;
            }, 0);
            const shipping = subtotal > 0 ? 6.5 : 0;
            const taxes = subtotal * 0.18;
            const total = subtotal + shipping + taxes;

            const order = {
                id: `ORD-${Date.now()}`,
                createdAt: new Date().toISOString(),
                status: 'Pendiente de pago',
                userEmail: activeSession?.email || null,
                shippingMethod: document.getElementById('shipping-method').value,
                paymentMethod: document.getElementById('payment-method').value,
                items: cart,
                total,
                subtotal,
                taxes,
                shipping,
                contact: fields.reduce((acc, id) => { acc[id] = document.getElementById(id).value.trim(); return acc; }, {})
            };
            const existing = JSON.parse(localStorage.getItem(ordersKey) || '[]');
            existing.unshift(order);
            localStorage.setItem(ordersKey, JSON.stringify(existing));
            confirmation.style.display = 'block';
            confirmation.innerHTML = `Orden ${order.id} creada en estado <strong>Pendiente de pago</strong>. Conecta tu gateway para capturar el pago.<br><br><a class="btn" href="ordenes.html" style="margin-top:0.5rem; display:inline-flex;">Ver detalle</a>`;
        });

        refreshSession();
        loadProfile();
        renderCart();
    </script>
    <script>
        const canvas = document.getElementById('canvas-bg');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let particlesArray = [];
        let speedMultiplier = 1;
        let scrollTimeout;
        const hues = [90, 110, 135, 155, 180, 210];
        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 3 + 0.5;
                this.speedX = (Math.random() * 2 - 1) * this.size * 0.18;
                this.speedY = (Math.random() * 2 - 1) * this.size * 0.18;
                const hue = hues[Math.floor(Math.random() * hues.length)];
                const lightness = 45 + Math.random() * 35;
                const alpha = 0.18 + Math.random() * 0.32;
                this.color = `hsla(${hue}, 70%, ${lightness}%, ${alpha})`;
            }
            update() {
                this.x += this.speedX * speedMultiplier;
                this.y += this.speedY * speedMultiplier;
                if (this.x > canvas.width) this.x = 0; else if (this.x < 0) this.x = canvas.width;
                if (this.y > canvas.height) this.y = 0; else if (this.y < 0) this.y = canvas.height;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
            }
        }
        function initParticles() {
            particlesArray = [];
            const numberOfParticles = (canvas.width * canvas.height) / 9000;
            for (let i = 0; i < numberOfParticles; i++) particlesArray.push(new Particle());
        }
        function animate() {
            requestAnimationFrame(animate);
            ctx.clearRect(0,0,canvas.width,canvas.height);
            particlesArray.forEach(p => { p.update(); p.draw(); });
        }
        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; initParticles(); });
        window.addEventListener('wheel', () => { speedMultiplier = 3; clearTimeout(scrollTimeout); scrollTimeout = setTimeout(() => speedMultiplier = 1, 250); });
        initParticles();
        animate();
    </script>
</body>
</html>
